<?php
/**
 * Part of the Joomla Framework CVE Package
 *
 * @copyright  Copyright (C) 2021 Open Source Matters, Inc. All rights reserved.
 * @license    GNU General Public License version 2 or later; see LICENSE
 */

namespace Joomla\Cve;

/**
 * Class CveId
 *
 * @since  __DEPLOY_VERSION__
 */
final class CveId // Immutable value object, see JSON return object
{
	public const RESERVED = 'RESERVED';
	public const PUBLIC   = 'PUBLIC';
	public const REJECT   = 'REJECT';

	/** @var array The CVE ID */
	private $id;

	/**
	 * CveId constructor.
	 *
	 * Format:
	 * {
	 *     "requested_by": {
	 *         "cna": "education",
	 *         "user": "angelaclark@education.com"
	 *     },
	 *     "cve_id": "CVE-2021-0023",
	 *     "cve_year": "2021",
	 *     "state": "RESERVED",
	 *     "owning_cna": "education",
	 *     "reserved": "2020-11-13T19:37:34.854Z"
	 * }
	 *
	 * @param  array  $id  An array representing the CVE ID
	 */
	public function __construct(array $id)
	{
		try {
			$this->id['cna']      = $id['requested_by']['cna'];
			$this->id['user']     = $id['requested_by']['user'];
			$this->id['id']       = $id['cve_id'];
			$this->id['year']     = $id['cve_year'];
			$this->id['state']    = $id['state'];
			$this->id['owner']    = $id['owning_cna'];
			$this->id['reserved'] = $id['reserved'];
		} catch (\Throwable $exception) {
			throw new \UnexpectedValueException('Argument for CveId constructor seems not to be a valid CVE ID',
				0,
				$exception);
		}
	}

	public function requestingCna(): string
	{
		return $this->id['cna'];
	}

	public function requestingUser(): string
	{
		return $this->id['user'];
	}

	public function cveId(): string
	{
		return $this->id['id'];
	}

	public function cveYear(): int
	{
		return (int) $this->id['year'];
	}

	public function state(): string
	{
		return $this->id['state'];
	}

	public function owningCna(): string
	{
		return $this->id['owner'];
	}

	public function reservedAt(): \DateTime
	{
		return new \DateTime($this->id['reserved'], new \DateTimeZone('UTC'));
	}

	public function __toString(): string
	{
		return (string) $this->id['id'];
	}
}
